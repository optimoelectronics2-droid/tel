<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Trifusion Technologies ‚Äî Cat√°logo</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
    margin:0;
    font-family:system-ui, Arial, sans-serif;
    background:#0b0f19;
    color:#e6ecff;
}
header{
    padding:18px;
    background:#000;
}
.catalogo{
    max-width:1100px;
    margin:30px auto;
    padding:0 16px;
}
.categoria{
    margin:26px 0 14px;
    padding:14px 18px;
    background:rgba(0,194,255,.25);
    border-left:6px solid #00c2ff;
    font-weight:800;
    letter-spacing:.18em;
    text-transform:uppercase;
}
.producto{
    background:#101624;
    border:1px solid #1f2940;
    border-radius:12px;
    padding:14px;
    margin-bottom:10px;
    display:flex;
    justify-content:space-between;
    gap:12px;
    align-items:center;
}
.descripcion{
    color:#00c2ff;
    font-weight:600;
    flex:1;
}
.precio{
    color:#ff4b6a;
    font-weight:700;
    white-space:nowrap;
}
.btn-img{
    background:#00c2ff;
    color:#02030a;
    border:none;
    border-radius:8px;
    padding:6px 10px;
    cursor:pointer;
    font-weight:700;
}
.modal{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.85);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:999;
}
.modal img{
    max-width:90%;
    max-height:90%;
    border-radius:10px;
}
</style>
</head>

<body>

<header>
    <h1>Trifusion Technologies</h1>
</header>

<div id="catalogo" class="catalogo"></div>

<div id="modal" class="modal" onclick="this.style.display='none'">
    <img id="modalImg">
</div>

<!-- LIBRER√çAS -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="firebase-config.js"></script>

<script>
// ================== CONFIG ==================
const SHEET_ID = "1EtOwxNRGq0WFgGaRXtJgibUqzxIgcAUeRkJlr1wPsLc";
const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv`;
const cont = document.getElementById("catalogo");

// ================== HELPERS ==================
function limpiarEmojis(txt){
    return txt.replace(/[\u{1F300}-\u{1FAFF}]/gu, "").trim();
}

function idProducto(text){
    return limpiarEmojis(text)
        .toLowerCase()
        .replace(/[^a-z0-9]+/g,"-")
        .replace(/(^-|-$)/g,"");
}

function soloUnaColumnaConTexto(row){
    return row.filter(c => (c||"").trim()).length === 1;
}

function esCategoria(row){
    if(!soloUnaColumnaConTexto(row)) return false;
    const texto = row.find(c => (c||"").trim()).trim();
    if(/\d/.test(texto)) return false;
    if(texto.length > 15) return false;
    if(texto.toUpperCase().includes("TRANSITO")) return false;
    return true;
}

function formatearPrecio(n){
    return "$" + Number(n).toLocaleString("es-DO");
}

// ================== CARGAR IM√ÅGENES ==================
let imagenes = {};

db.collection("products").get().then(snap=>{
    snap.forEach(doc=>{
        imagenes[doc.id] = doc.data().image;
    });
});

// ================== CARGAR CAT√ÅLOGO ==================
fetch(CSV_URL)
.then(r=>r.text())
.then(csv=>{
    Papa.parse(csv,{
        skipEmptyLines:true,
        complete:(res)=>{
            cont.innerHTML = "";

            res.data.forEach(row=>{
                const A = (row[0]||"").trim();
                const C = (row[2]||"").trim();
                const D = (row[3]||"").trim();

                // üîµ CATEGOR√çA
                if(esCategoria(row)){
                    const cat = document.createElement("div");
                    cat.className = "categoria";
                    cat.textContent = limpiarEmojis(
                        row.find(c => (c||"").trim()).trim()
                    );
                    cont.appendChild(cat);
                    return;
                }

                // üö´ TR√ÅNSITO
                if(D.toUpperCase().includes("TRANSITO")) return;

                if(!C || !D) return;
                const num = D.replace(/[^0-9]/g,"");
                if(!num) return;

                const nombre = limpiarEmojis(A ? A+" " : "") + C;
                const id = idProducto(nombre);
                const img = imagenes[id];

                const prod = document.createElement("div");
                prod.className = "producto";
                prod.innerHTML = `
                    <div class="descripcion">${nombre}</div>
                    ${img ? `<button class="btn-img" onclick="verImg('${img}')">üì∑</button>` : ""}
                    <div class="precio">${formatearPrecio(num)}</div>
                `;
                cont.appendChild(prod);
            });
        }
    });
});

// ================== MODAL ==================
function verImg(src){
    modalImg.src = src;
    modal.style.display="flex";
}
</script>

</body>
</html>
