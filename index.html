<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Trifusion Technologies ‚Äî Cat√°logo</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{margin:0;font-family:system-ui;background:#0b0f19;color:#e6ecff}
header{background:#000;padding:14px;display:flex;justify-content:space-between;align-items:center}
.catalogo{max-width:1100px;margin:20px auto;padding:0 16px}
.categoria{margin:24px 0 10px;padding:12px;background:#00394d;font-weight:800}
.producto{background:#101624;border-radius:10px;padding:10px;margin-bottom:8px;display:flex;gap:8px;align-items:center}
.descripcion{flex:1;color:#00c2ff;font-weight:600}
.precio{color:#ff4b6a;font-weight:700}
.btn{border:none;padding:6px 10px;border-radius:6px;cursor:pointer;font-weight:700}
.admin{background:#ffb703;color:#000}
.img{background:#00c2ff;color:#000}
.modal,.login{position:fixed;inset:0;background:rgba(0,0,0,.9);display:none;align-items:center;justify-content:center;z-index:1000}
.modal img{max-width:90%;max-height:90%}
.login-box{background:#101624;padding:20px;border-radius:10px;width:280px}
.login-box input{width:100%;padding:8px;margin-top:8px}
</style>
</head>

<body>

<header>
  <h2>Trifusion Technologies</h2>
  <button id="adminBtn" class="btn admin">ADMIN</button>
</header>

<div id="catalogo" class="catalogo"></div>

<!-- MODALES -->
<div id="imgModal" class="modal" onclick="this.style.display='none'">
  <img id="imgView">
</div>

<div id="login" class="login">
  <div class="login-box">
    <h3>Admin</h3>
    <input id="email" placeholder="Email">
    <input id="password" type="password">
    <button class="btn admin" onclick="login()">Entrar</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="firebase-config.js"></script>

<script>
const SHEET_ID="1EtOwxNRGq0WFgGaRXtJgibUqzxIgcAUeRkJlr1wPsLc";
const CSV_URL=`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv`;
const cont=document.getElementById("catalogo");
let isAdmin=false;
let images={};

adminBtn.onclick=()=>login.style.display="flex";

auth.onAuthStateChanged(u=>{
  isAdmin=!!u;
  login.style.display="none";
  cargar();
});

function login(){
  auth.signInWithEmailAndPassword(email.value,password.value)
    .catch(e=>alert(e.message));
}

function limpiar(t){
  return t.replace(/[\u{1F300}-\u{1FAFF}]/gu,"").trim();
}
function pid(t){
  return limpiar(t).toLowerCase().replace(/[^a-z0-9]+/g,"-");
}
function precio(n){
  return "$"+Number(n).toLocaleString("es-DO");
}

function cargarImgs(){
  return db.collection("products").get().then(s=>{
    images={};
    s.forEach(d=>images[d.id]=d.data().image);
  });
}

function cargar(){
  cargarImgs().then(()=>{
    cont.innerHTML="";
    fetch(CSV_URL).then(r=>r.text()).then(csv=>{
      Papa.parse(csv,{
        skipEmptyLines:true,
        complete:res=>{
          res.data.forEach(row=>{
            const A=(row[0]||"").trim();
            const C=(row[2]||"").trim();
            const D=(row[3]||"").trim();
            if(!C||!D||D.includes("TRANSITO")) return;

            const n=D.replace(/\D/g,"");
            if(!n) return;

            const name=limpiar((A?A+" ":"")+C);
            const id=pid(name);
            const img=images[id];

            const div=document.createElement("div");
            div.className="producto";
            div.innerHTML=`
              <div class="descripcion">${name}</div>
              ${img?`<button class="btn img" onclick="ver('${img}')">üì∑</button>`:""}
              ${isAdmin?`<button class="btn admin" onclick="edit('${id}')">‚úèÔ∏è</button>`:""}
              <div class="precio">${precio(n)}</div>
            `;
            cont.appendChild(div);
          });
        }
      });
    });
  });
}

function edit(id){
  const link=prompt("Link p√∫blico de imagen:");
  if(link===null) return;
  if(!link) db.collection("products").doc(id).delete().then(cargar);
  else db.collection("products").doc(id).set({image:link}).then(cargar);
}

function ver(src){
  imgView.src=src;
  imgModal.style.display="flex";
}

cargar();
</script>
</body>
</html>
