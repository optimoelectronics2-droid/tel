<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Trifusion Technologies — Catálogo</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
    margin:0;
    font-family:system-ui, Arial;
    background:#0b0f19;
    color:#e6ecff;
}
header{
    padding:18px;
    background:#000;
    display:flex;
    justify-content:space-between;
    align-items:center;
}
button{
    background:#00c2ff;
    border:none;
    padding:8px 14px;
    border-radius:8px;
    font-weight:700;
    cursor:pointer;
}
.catalogo{
    max-width:1100px;
    margin:30px auto;
    padding:0 16px;
}
.categoria{
    margin:26px 0 14px;
    padding:14px 18px;
    background:rgba(0,194,255,.25);
    border-left:6px solid #00c2ff;
    font-weight:800;
    letter-spacing:.18em;
}
.producto{
    background:#101624;
    border:1px solid #1f2940;
    border-radius:12px;
    padding:14px;
    margin-bottom:10px;
}
.descripcion{
    color:#00c2ff;
    font-weight:600;
}
.precio{
    color:#ff4b6a;
    font-weight:700;
}
img{
    max-width:160px;
    border-radius:8px;
    margin-top:10px;
}
.admin{
    margin-top:10px;
}
input{
    width:100%;
    padding:6px;
    margin-top:6px;
}
</style>
</head>

<body>

<header>
  <h2>Trifusion Technologies</h2>
  <div>
    <button id="loginBtn">Admin</button>
    <button id="logoutBtn" style="display:none;">Salir</button>
  </div>
</header>

<div class="catalogo" id="catalogo"></div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<script src="firebase-config.js"></script>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script>
const SHEET_ID="1EtOwxNRGq0WFgGaRXtJgibUqzxIgcAUeRkJlr1wPsLc";
const CSV_URL=`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv`;

const auth=firebase.auth();
const db=firebase.firestore();
let isAdmin=false;

auth.onAuthStateChanged(u=>{
  isAdmin=!!u;
  loginBtn.style.display=isAdmin?"none":"inline";
  logoutBtn.style.display=isAdmin?"inline":"none";
  cargarCatalogo();
});

loginBtn.onclick=()=>{
  const e=prompt("Email admin:");
  const p=prompt("Password:");
  auth.signInWithEmailAndPassword(e,p).catch(a=>alert(a.message));
};
logoutBtn.onclick=()=>auth.signOut();

function slug(t){
  return t.toLowerCase()
  .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
  .replace(/[^a-z0-9]+/g,"-");
}

function limpiar(txt){
  return txt.replace(/[\u{1F300}-\u{1FAFF}]/gu,"").trim();
}

function esCategoria(row){
  const filled=row.filter(c=>(c||"").trim());
  if(filled.length!==1) return false;
  const t=filled[0];
  return !/\d/.test(t) && t.length<16;
}

async function cargarCatalogo(){
  const cont=document.getElementById("catalogo");
  cont.innerHTML="";

  const res=await fetch(CSV_URL);
  const csv=await res.text();

  Papa.parse(csv,{
    skipEmptyLines:true,
    complete: async r=>{
      for(const row of r.data){
        const A=(row[0]||"").trim();
        const C=(row[2]||"").trim();
        const D=(row[3]||"").trim();

        if(esCategoria(row)){
          const div=document.createElement("div");
          div.className="categoria";
          div.textContent=limpiar(row.find(c=>c));
          cont.appendChild(div);
          continue;
        }

        if(!C||!D||D.toUpperCase().includes("TRANSITO")) continue;

        const id=slug(C);
        const doc=await db.collection("products").doc(id).get();
        const img=doc.exists?doc.data().imageUrl:null;

        const p=document.createElement("div");
        p.className="producto";
        p.innerHTML=`
          <div class="descripcion">${limpiar(C)}</div>
          <div class="precio">$${D.replace(/[^0-9]/g,"")}</div>
          ${img?`<img src="${img}">`:""}
          ${isAdmin?`
            <div class="admin">
              <input placeholder="Link imagen pública" value="${img||""}">
              <button>Guardar imagen</button>
              ${img?`<button>Eliminar</button>`:""}
            </div>`:""}
        `;
        cont.appendChild(p);

        if(isAdmin){
          const input=p.querySelector("input");
          const btn=p.querySelector("button");
          btn.onclick=()=>{
            db.collection("products").doc(id)
              .set({imageUrl:input.value,updatedAt:firebase.firestore.FieldValue.serverTimestamp()});
          };
          const del=p.querySelectorAll("button")[1];
          if(del) del.onclick=()=>{
            db.collection("products").doc(id).delete();
            cargarCatalogo();
          };
        }
      }
    }
  });
}

cargarCatalogo();
</script>

</body>
</html>
