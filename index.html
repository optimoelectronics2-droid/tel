
                        <!DOCTYPE html>
                        <html lang="en">
                        <head>
                            <meta charset="UTF-8">
                            <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <style>
                body {
                  background-color: white; /* Ensure the iframe has a white background */
                }

                
              </style>
                        </head>
                        <body>
                            

              <script>
                              function generarHuella(nombre) {
    // Normalizar: min√∫sculas, sin emojis, sin caracteres especiales, espacios √∫nicos
    return nombre
        .toLowerCase()
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
        .replace(/[\u{1F300}-\u{1FAFF}]/gu, "") // Eliminar emojis
        .replace(/[^a-z0-9\s]/g, " ")           // Solo letras, n√∫meros y espacios
        .replace(/\s+/g, " ")                    // Espacios m√∫ltiples ‚Üí uno
        .trim();
}

let mapaHuellas = {}; // huella ‚Üí { id, imageUrl }

async function precargarHuellas() {
    try {
        const snapshot = await db.collection("products").get();
        mapaHuellas = {};
        snapshot.forEach(doc => {
            const data = doc.data();
            if (data.huella) {
                mapaHuellas[data.huella] = {
                    id: doc.id,
                    imageUrl: data.imageUrl || "",
                    updatedAt: data.updatedAt?.toDate?.() || null
                };
            }
        });
        console.log(`‚úÖ ${Object.keys(mapaHuellas).length} huellas cargadas`);
    } catch (error) {
        console.error("‚ö†Ô∏è Error cargando huellas:", error);
    }
}

// Dentro del bucle de productos, despu√©s de limpiar el nombre:
const huella = generarHuella(nombreLimpio); // ‚Üê NUEVA L√çNEA
const datosProducto = mapaHuellas[huella] || { id: null, imageUrl: "" }; // ‚Üê NUEVA L√çNEA
const imageUrl = datosProducto.imageUrl; // ‚Üê NUEVA L√çNEA (reemplaza la l√≥gica anterior de im√°genes)

// En el bot√≥n "Guardar Imagen" del admin:
if (saveBtn) {
    saveBtn.addEventListener("click", async () => {
        const url = urlInput.value.trim();
        if (!url) {
            alert("Por favor ingresa una URL v√°lida");
            return;
        }
        
        const huella = generarHuella(nombreLimpio);
        const existe = mapaHuellas[huella];
        
        try {
            if (existe?.id) {
                // Actualizar documento existente
                await db.collection("products").doc(existe.id).update({
                    imageUrl: url,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            } else {
                // Crear nuevo documento con huella
                await db.collection("products").add({
                    huella: huella,
                    imageUrl: url,
                    nombreOriginal: nombreLimpio,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
            
            alert(`‚úÖ Imagen guardada para "${nombreLimpio}"`);
            await precargarHuellas(); // Recargar mapa
            renderCatalogo(rows); // Refrescar vista
        } catch (error) {
            console.error("Error guardando imagen:", error);
            alert("Error al guardar la imagen: " + error.message);
        }
    });
}

// En el bot√≥n "Eliminar Imagen":
if (deleteBtn) {
    deleteBtn.addEventListener("click", async () => {
        if (!confirm(`¬øEliminar la imagen de "${nombreLimpio}"?`)) return;
        
        const huella = generarHuella(nombreLimpio);
        const existe = mapaHuellas[huella];
        
        if (!existe?.id) {
            alert("No hay imagen para eliminar");
            return;
        }
        
        try {
            // Solo eliminamos el campo imageUrl, NO el documento
            // As√≠ la huella persiste si el producto vuelve
            await db.collection("products").doc(existe.id).update({
                imageUrl: firebase.firestore.FieldValue.delete(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            alert(`‚úÖ Imagen eliminada para "${nombreLimpio}"`);
            await precargarHuellas();
            renderCatalogo(rows);
        } catch (error) {
            console.error("Error eliminando imagen:", error);
            alert("Error al eliminar la imagen: " + error.message);
        }
    });
}

// Reemplazar la inicializaci√≥n actual con esto:
window.addEventListener("DOMContentLoaded", async () => {
    await precargarHuellas(); // ‚Üê CARGA LAS HUELLAS PRIMERO
    auth.onAuthStateChanged(user => {
        esAdmin = !!user;
        document.getElementById("btnLogin").style.display = esAdmin ? "none" : "inline-flex";
        document.getElementById("btnLogout").style.display = esAdmin ? "inline-flex" : "none";
        document.getElementById("adminEmail").value = "";
        document.getElementById("adminPassword").value = "";
        loginModal.classList.remove("active");
        cargarCatalogo(); // ‚Üê CARGA CAT√ÅLOGO DESPU√âS DE HUELLAS
    });
});

// =========================
// CONFIGURACI√ìN
// =========================
const SHEET_ID = "1EtOwxNRGq0WFgGaRXtJgibUqzxIgcAUeRkJlr1wPsLc";
const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv`;
const IMPUESTO = 1.22; // 22% de impuesto
const cont = document.getElementById("catalogo");
const buscador = document.getElementById("buscadorProductos");
const mensajeVacio = document.getElementById("mensajeVacio");
const loginModal = document.getElementById("loginModal");
const imageModal = document.getElementById("imageModal");
const modalImage = document.getElementById("modalImage");
const closeModal = document.querySelector(".close-modal");
const loginBtn = document.getElementById("btnLogin");
const logoutBtn = document.getElementById("btnLogout");
const submitLogin = document.getElementById("submitLogin");

let esAdmin = false;
let todosLosProductos = [];
let mapaHuellas = {}; // huella ‚Üí { id, imageUrl }

// =========================
// FUNCIONES AUXILIARES
// =========================
function limpiarEmojis(txt) {
    return txt.replace(/[\u{1F300}-\u{1FAFF}]/gu, "").trim();
}

function generarHuella(nombre) {
    // Normalizaci√≥n robusta y tolerante
    return nombre
        .toLowerCase()
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
        .replace(/[\u{1F300}-\u{1FAFF}]/gu, "")
        .replace(/[^a-z0-9\s]/g, " ")
        .replace(/\s+/g, " ")
        .trim();
}

function formatearPrecio(num) {
    return "$" + num.toLocaleString("es-DO");
}

function esCategoria(row) {
    const celdasNoVacias = row.filter(c => (c || "").trim() !== "");
    if (celdasNoVacias.length !== 1) return false;
    
    const texto = celdasNoVacias[0].trim();
    if (/\d/.test(texto)) return false;
    if (texto.length > 15) return false;
    if (texto.toUpperCase().includes("TRANSITO")) return false;
    
    return true;
}

// =========================
// CARGA DE HUELLAS (CLAVE)
// =========================
async function precargarHuellas() {
    try {
        const snapshot = await db.collection("products").get();
        mapaHuellas = {};
        snapshot.forEach(doc => {
            const data = doc.data();
            if (data.huella) {
                mapaHuellas[data.huella] = {
                    id: doc.id,
                    imageUrl: data.imageUrl || "",
                    updatedAt: data.updatedAt?.toDate?.() || null
                };
            }
        });
        console.log(`‚úÖ ${Object.keys(mapaHuellas).length} huellas cargadas`);
    } catch (error) {
        console.error("‚ö†Ô∏è Error cargando huellas:", error);
    }
}

// =========================
// AUTENTICACI√ìN
// =========================
loginBtn.addEventListener("click", () => {
    loginModal.classList.add("active");
});

logoutBtn.addEventListener("click", () => {
    auth.signOut();
});

submitLogin.addEventListener("click", () => {
    const email = document.getElementById("adminEmail").value.trim();
    const password = document.getElementById("adminPassword").value.trim();
    
    if (!email || !password) {
        alert("Por favor ingresa correo y contrase√±a");
        return;
    }
    
    auth.signInWithEmailAndPassword(email, password)
        .catch(error => {
            let message = "Error al iniciar sesi√≥n. ";
            if (error.code === "auth/invalid-email") {
                message += "Correo electr√≥nico inv√°lido.";
            } else if (error.code === "auth/wrong-password") {
                message += "Contrase√±a incorrecta.";
            } else if (error.code === "auth/user-not-found") {
                message += "Usuario no encontrado.";
            } else {
                message += error.message;
            }
            alert(message);
        });
});

closeModal.addEventListener("click", () => {
    imageModal.classList.remove("active");
});

imageModal.addEventListener("click", (e) => {
    if (e.target === imageModal) {
        imageModal.classList.remove("active");
    }
});

loginModal.addEventListener("click", (e) => {
    if (e.target === loginModal) {
        loginModal.classList.remove("active");
    }
});

// =========================
// CARGAR CAT√ÅLOGO
// =========================
async function cargarCatalogo() {
    try {
        cont.innerHTML = '<div style="text-align:center;padding:30px;color:var(--accent)">Cargando productos...</div>';
        
        // Cargar CSV
        const resp = await fetch(CSV_URL);
        if (!resp.ok) throw new Error(`Error al cargar: ${resp.status}`);
        
        const csv = await resp.text();
        
        Papa.parse(csv, {
            skipEmptyLines: true,
            complete: (results) => {
                todosLosProductos = results.data;
                renderCatalogo(results.data);
            },
            error: (err) => {
                console.error("Error parsing CSV:", err);
                cont.innerHTML = `<div class="status-error">‚ùå Error al procesar el cat√°logo</div>`;
            }
        });
    } catch (error) {
        console.error("Error fetching catalog:", error);
        cont.innerHTML = `<div class="status-error">‚ùå Error: ${error.message}</div>`;
    }
}

function renderCatalogo(rows) {
    cont.innerHTML = "";
    const filtro = buscador.value.trim().toLowerCase();
    let productosMostrados = 0;
    
    rows.forEach(row => {
        const A = (row[0] || "").trim();
        const C = (row[2] || "").trim();
        const D = (row[3] || "").trim();
        
        // Renderizar categor√≠a
        if (esCategoria(row)) {
            const textoCategoria = limpiarEmojis(row.find(c => (c || "").trim()) || "");
            const catEl = document.createElement("div");
            catEl.className = "categoria";
            catEl.innerHTML = `<div style="padding:14px 18px;background:rgba(0,194,255,0.25);border-left:6px solid #00c2ff;font-weight:800;letter-spacing:.18em;text-transform:uppercase">${textoCategoria}</div>`;
            cont.appendChild(catEl);
            return;
        }
        
        // Saltar productos en TR√ÅNSITO o inv√°lidos
        if (D.toUpperCase().includes("TRANSITO") || !C || !D) return;
        
        // Aplicar filtro de b√∫squeda
        if (filtro && !C.toLowerCase().includes(filtro)) return;
        
        // Calcular precio con impuesto (22%)
        const precioBase = D.replace(/[^0-9]/g, "");
        if (!precioBase) return;
        
        const precioConImpuesto = Math.round(parseFloat(precioBase) * IMPUESTO);
        
        // Generar nombre limpio y huella
        const nombreLimpio = limpiarEmojis(A ? A + " " : "") + C;
        const huella = generarHuella(nombreLimpio); // ‚Üê CLAVE: Huella estable
        
        // Obtener datos del producto desde el mapa de huellas
        const datosProducto = mapaHuellas[huella] || { id: null, imageUrl: "" };
        const imageUrl = datosProducto.imageUrl;
        
        // Crear elemento de producto
        const prodEl = document.createElement("div");
        prodEl.className = "producto";
        
        // HTML del producto
        let htmlProducto = `
            <div class="producto-content">
                <div class="descripcion">${nombreLimpio}</div>
        `;
        
        // Mostrar imagen si existe
        if (imageUrl) {
            htmlProducto += `
                <div class="producto-img-container">
                    <img src="${imageUrl}" alt="${nombreLimpio}" class="producto-img" referrerpolicy="no-referrer">
                </div>
            `;
        }
        
        htmlProducto += `
            </div>
            <div class="producto-right">
                <div class="precio">${formatearPrecio(precioConImpuesto)}</div>
        `;
        
        // Secci√≥n de administraci√≥n si es admin
        if (esAdmin) {
            htmlProducto += `
                <div class="admin-section">
                    <h4>üì∏ Imagen del Producto</h4>
                    <input type="text" class="admin-input image-url" placeholder="Pega URL de imagen" value="${imageUrl}">
                    <div class="admin-actions">
                        <button class="btn btn-save-img save-image" data-nombre="${nombreLimpio}">üíæ Guardar</button>
                        ${imageUrl ? `<button class="btn btn-delete-img delete-image" data-nombre="${nombreLimpio}">üóëÔ∏è Eliminar</button>` : ''}
                    </div>
                </div>
            `;
        }
        
        htmlProducto += `</div>`;
        prodEl.innerHTML = htmlProducto;
        
        // Evento para ver imagen en modal
        if (imageUrl) {
            const imgEl = prodEl.querySelector(".producto-img");
            imgEl.addEventListener("click", (e) => {
                e.stopPropagation();
                modalImage.src = imageUrl;
                imageModal.classList.add("active");
            });
        }
        
        // Eventos de administraci√≥n
        if (esAdmin) {
            const saveBtn = prodEl.querySelector(".save-image");
            const deleteBtn = prodEl.querySelector(".delete-image");
            const urlInput = prodEl.querySelector(".image-url");
            const nombreProducto = nombreLimpio; // Capturar nombre para el evento
            
            if (saveBtn) {
                saveBtn.addEventListener("click", async () => {
                    const url = urlInput.value.trim();
                    if (!url) {
                        alert("Por favor ingresa una URL v√°lida");
                        return;
                    }
                    
                    const huellaActual = generarHuella(nombreProducto);
                    const existe = mapaHuellas[huellaActual];
                    
                    try {
                        if (existe?.id) {
                            // Actualizar documento existente
                            await db.collection("products").doc(existe.id).update({
                                imageUrl: url,
                                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                        } else {
                            // Crear nuevo documento con huella
                            await db.collection("products").add({
                                huella: huellaActual,
                                imageUrl: url,
                                nombreOriginal: nombreProducto,
                                createdAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                        }
                        
                        alert(`‚úÖ Imagen guardada para "${nombreProducto}"`);
                        await precargarHuellas(); // Recargar mapa de huellas
                        renderCatalogo(rows); // Refrescar vista
                    } catch (error) {
                        console.error("Error guardando imagen:", error);
                        alert("Error al guardar la imagen: " + error.message);
                    }
                });
            }
            
            if (deleteBtn) {
                deleteBtn.addEventListener("click", async () => {
                    if (!confirm(`¬øEliminar la imagen de "${nombreProducto}"?`)) return;
                    
                    const huellaActual = generarHuella(nombreProducto);
                    const existe = mapaHuellas[huellaActual];
                    
                    if (!existe?.id) {
                        alert("No hay imagen para eliminar");
                        return;
                    }
                    
                    try {
                        // Solo eliminamos el campo imageUrl, NO el documento
                        // As√≠ la huella persiste si el producto vuelve
                        await db.collection("products").doc(existe.id).update({
                            imageUrl: firebase.firestore.FieldValue.delete(),
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        
                        alert(`‚úÖ Imagen eliminada para "${nombreProducto}"`);
                        await precargarHuellas();
                        renderCatalogo(rows);
                    } catch (error) {
                        console.error("Error eliminando imagen:", error);
                        alert("Error al eliminar la imagen: " + error.message);
                    }
                });
            }
        }
        
        cont.appendChild(prodEl);
        productosMostrados++;
    });
    
    // Mostrar mensaje si no hay productos
    mensajeVacio.style.display = productosMostrados === 0 ? "block" : "none";
}

// =========================
// EVENTOS
// =========================
buscador.addEventListener("input", (e) => {
    renderCatalogo(todosLosProductos);
});

// Inicializaci√≥n mejorada
window.addEventListener("DOMContentLoaded", async () => {
    await precargarHuellas(); // ‚Üê CARGA LAS HUELLAS PRIMERO
    
    auth.onAuthStateChanged(user => {
        esAdmin = !!user;
        loginBtn.style.display = esAdmin ? "none" : "inline-flex";
        logoutBtn.style.display = esAdmin ? "inline-flex" : "none";
        document.getElementById("adminEmail").value = "";
        document.getElementById("adminPassword").value = "";
        loginModal.classList.remove("active");
        cargarCatalogo(); // ‚Üê CARGA CAT√ÅLOGO DESPU√âS DE HUELLAS
    });
});


              </script>
                        </body>
                        </html>
                    
