<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Admin — Trifusion Technologies</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
    font-family:system-ui, Arial;
    background:#0b0f19;
    color:#e6ecff;
    margin:0;
    padding:20px;
}
h1{margin-bottom:10px}
input, button{
    padding:10px;
    border-radius:8px;
    border:none;
    margin:4px 0;
    width:100%;
}
button{
    cursor:pointer;
    font-weight:700;
}
.login, .panel{
    max-width:420px;
    margin:auto;
    background:#101624;
    padding:20px;
    border-radius:12px;
    border:1px solid #1f2940;
}
.producto{
    border:1px solid #1f2940;
    border-radius:10px;
    padding:10px;
    margin-top:10px;
}
.acciones{
    display:flex;
    gap:6px;
}
.acciones button{
    flex:1;
}
.img-preview{
    width:100%;
    margin-top:6px;
    border-radius:8px;
}
</style>
</head>

<body>

<div id="login" class="login">
    <h1>Admin Login</h1>
    <input id="email" placeholder="Email">
    <input id="password" type="password" placeholder="Password">
    <button onclick="login()">Entrar</button>
</div>

<div id="panel" class="panel" style="display:none">
    <h1>Productos</h1>

    <input id="name" placeholder="Nombre del producto">
    <input id="image" placeholder="Link público de imagen (Drive)">
    <button onclick="guardar()">Guardar / Actualizar</button>

    <div id="lista"></div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="firebase-config.js"></script>

<script>
// =====================
// HELPERS
// =====================
function limpiarEmojis(txt){
    return txt.replace(/[\u{1F300}-\u{1FAFF}]/gu, "").trim();
}

function productId(text){
    return limpiarEmojis(text)
        .toLowerCase()
        .replace(/[^a-z0-9]+/g,"-")
        .replace(/(^-|-$)/g,"");
}

// =====================
// AUTH
// =====================
function login(){
    auth.signInWithEmailAndPassword(
        email.value,
        password.value
    ).catch(alert);
}

auth.onAuthStateChanged(user=>{
    if(user){
        login.style.display="none";
        panel.style.display="block";
        cargar();
    }
});

// =====================
// CRUD
// =====================
function guardar(){
    const nombre = name.value.trim();
    const img = image.value.trim();
    if(!nombre) return alert("Nombre requerido");

    const id = productId(nombre);

    db.collection("products").doc(id).set({
        image: img || ""
    }).then(()=>{
        name.value="";
        image.value="";
        cargar();
    });
}

function cargar(){
    lista.innerHTML="";
    db.collection("products").get().then(snap=>{
        snap.forEach(doc=>{
            const d = doc.data();
            const div = document.createElement("div");
            div.className="producto";
            div.innerHTML=`
                <strong>${doc.id}</strong>
                ${d.image ? `<img class="img-preview" src="${d.image}">` : ""}
                <div class="acciones">
                    <button onclick="editar('${doc.id}','${d.image||""}')">Editar</button>
                    <button onclick="borrar('${doc.id}')">Borrar</button>
                </div>
            `;
            lista.appendChild(div);
        });
    });
}

function editar(id,img){
    name.value = id.replace(/-/g," ");
    image.value = img;
    window.scrollTo(0,0);
}

function borrar(id){
    if(!confirm("¿Borrar este producto?")) return;
    db.collection("products").doc(id).delete().then(cargar);
}
</script>

</body>
</html>
